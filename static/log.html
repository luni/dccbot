<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCCBot Log</title>
    <style>
        /* Basic styling */
        body {
            font-family: Arial, sans-serif;
            background-color: #1e1e1e;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            /* Full viewport height */
            box-sizing: border-box;
            color: #e0e0e0;
        }

        h1 {
            color: #dfdfdf;
            margin: 0 0 0.5em 0;
        }

        #logs {
            flex-grow: 1;
            font-family: monospace;
            font-size: 14px;
            background-color: #000;
            color: #fff;
            border: 1px solid #444;
            padding: 10px;
            box-sizing: border-box;
            white-space: pre-wrap;
            overflow-y: auto;
        }

        #command-input {
            width: 100%;
            padding: 10px;
            font-family: monospace;
            font-size: 14px;
            margin-top: 10px;
            box-sizing: border-box;
        }

        /* Colors for log levels */
        .log-info {
            color: #cccccc;
            /* Green for INFO */
        }

        .log-warning {
            color: #ffcc00;
            /* Yellow for WARNING */
        }

        .log-error {
            color: #ff0000;
            /* Red for ERROR */
        }

        .log-debug {
            color: #00ffff;
            /* Cyan for DEBUG */
        }

        .log-critical {
            color: #ff00ff;
            /* Magenta for CRITICAL */
        }
    </style>
</head>

<body>
    <h1>DCCBot Log</h1>
    <div id="logs" contenteditable="false"></div>
    <input type="text" id="command-input" placeholder="Enter a command (e.g., /echo Hello)">

    <script src="/static/ws.js"></script>
    <script>
        const logsElement = document.getElementById("logs");
        const commandInput = document.getElementById("command-input");
        const commandHistory = [];
        let historyIndex = -1;

        function trimLogs() {
            const logs = logsElement.innerHTML.split("<br>");
            if (logs.length > 300) {
                logsElement.innerHTML = logs.slice(-300).join("<br>");
            }
        }

        function escapeHTML(str) {
            return str.replace(
                /[&<>'"]/g,
                tag =>
                ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    "'": '&#39;',
                    '"': '&quot;'
                }[tag] || tag)
            );
        }

        function appendLogLine(logEntry) {
            let logLine;

            if (logEntry.status) {
                logLine = `<span class="log-warning">${logEntry.status}: ${logEntry.message}</span><br>`;
            } else {
                const timestamp = logEntry.timestamp;
                const level = logEntry.level.padEnd(8);
                const message = escapeHTML(logEntry.message);

                let logClass = "";
                switch (logEntry.level.toLowerCase()) {
                    case "info":
                        logClass = "log-info";
                        break;
                    case "warning":
                        logClass = "log-warning";
                        break;
                    case "error":
                        logClass = "log-error";
                        break;
                    case "debug":
                        logClass = "log-debug";
                        break;
                    case "critical":
                        logClass = "log-critical";
                        break;
                    default:
                        logClass = "";
                }

                logLine = `<span class="${logClass}">${timestamp} - ${level} - ${message}</span><br>`;
            }

            logsElement.innerHTML += logLine;
            trimLogs();
            logsElement.scrollTop = logsElement.scrollHeight;
        }

        const socket = createDccbotSocket({
            onLog: appendLogLine,
            onCommandResponse: appendLogLine,
            onError: (err) => console.error('WebSocket error:', err),
        });

        commandInput.addEventListener("keydown", (event) => {
            if (event.key === "ArrowUp") {
                if (commandHistory.length > 0) {
                    if (historyIndex > 0) {
                        historyIndex--;
                    }
                    commandInput.value = commandHistory[historyIndex];
                }
            } else if (event.key === "ArrowDown") {
                if (commandHistory.length > 0) {
                    if (historyIndex < commandHistory.length - 1) {
                        historyIndex++;
                        commandInput.value = commandHistory[historyIndex];
                    } else {
                        historyIndex = commandHistory.length;
                        commandInput.value = "";
                    }
                }
            }
        });

        commandInput.addEventListener("keyup", (event) => {
            if (event.key === "Enter") {
                const command = commandInput.value.trim();
                if (command) {
                    commandHistory.push(command);
                    if (commandHistory.length > 20) {
                        commandHistory.shift();
                    }
                    historyIndex = commandHistory.length;

                    socket.send(command);
                    commandInput.value = "";
                }
            }
        });
    </script>
</body>

</html>